{"version":3,"sources":["api/user/user.controller.js"],"names":["index","create","show","destroy","changePassword","changeEmail","changeUsername","me","authCallback","validationError","res","statusCode","err","status","json","handleError","send","req","find","populate","exec","then","users","catch","newUser","body","provider","role","save","user","token","sign","_id","secrets","session","expiresIn","next","userId","params","id","findById","end","profile","findByIdAndRemove","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","newEmail","email","newUsername","name","findOne","redirect"],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\r\n\r\nimport User from './user.model';\r\nimport config from '../../config/environment';\r\nimport jwt from 'jsonwebtoken';\r\n\r\nfunction validationError(res, statusCode) {\r\n  statusCode = statusCode || 422;\r\n  return function(err) {\r\n    return res.status(statusCode).json(err);\r\n  };\r\n}\r\n\r\nfunction handleError(res, statusCode) {\r\n  statusCode = statusCode || 500;\r\n  return function(err) {\r\n    return res.status(statusCode).send(err);\r\n  };\r\n}\r\n\r\n/**\r\n * Get list of users\r\n * restriction: 'admin'\r\n */\r\nexport function index(req, res) {\r\n  return User.find({}, '-salt -password').populate('characters', '').exec()\r\n    .then(users => {\r\n      res.status(200).json(users);\r\n    })\r\n    .catch(handleError(res));\r\n}\r\n\r\n/**\r\n * Creates a new user\r\n */\r\nexport function create(req, res) {\r\n  var newUser = new User(req.body);\r\n  newUser.provider = 'local';\r\n  newUser.role = 'user';\r\n  newUser.save()\r\n    .then(function(user) {\r\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\r\n        expiresIn: 60 * 60 * 5\r\n      });\r\n      res.json({ token });\r\n    })\r\n    .catch(validationError(res));\r\n}\r\n\r\n/**\r\n * Get a single user\r\n */\r\nexport function show(req, res, next) {\r\n  var userId = req.params.id;\r\n\r\n  return User.findById(userId).populate('characters', '').exec()\r\n    .then(user => {\r\n      if(!user) {\r\n        return res.status(404).end();\r\n      }\r\n      return res.json(user.profile);\r\n    })\r\n    .catch(err => next(err));\r\n}\r\n\r\n/**\r\n * Deletes a user\r\n * restriction: 'admin'\r\n */\r\nexport function destroy(req, res) {\r\n  return User.findByIdAndRemove(req.params.id).exec()\r\n    .then(function() {\r\n      res.status(204).end();\r\n    })\r\n    .catch(handleError(res));\r\n}\r\n\r\n/**\r\n * Change a users password\r\n */\r\nexport function changePassword(req, res) {\r\n  var userId = req.user._id;\r\n  var oldPass = String(req.body.oldPassword);\r\n  var newPass = String(req.body.newPassword);\r\n\r\n  return User.findById(userId).exec()\r\n    .then(user => {\r\n      if(user.authenticate(oldPass)) {\r\n        user.password = newPass;\r\n        return user.save()\r\n          .then(() => {\r\n            res.status(204).end();\r\n          })\r\n          .catch(validationError(res));\r\n      } else {\r\n        return res.status(403).end();\r\n      }\r\n    });\r\n}\r\n\r\n/**\r\n * Change a users email.\r\n */\r\nexport function changeEmail(req, res) {\r\n  var userId = req.user._id;\r\n  var newEmail = String(req.body.newEmail);\r\n  return User.findById(userId).exec()\r\n    .then(user => {\r\n      user.email = newEmail;\r\n      return user.save()\r\n        .then(() => {\r\n          res.status(204).end();\r\n        })\r\n        .catch(validationError(res));\r\n    });\r\n}\r\n\r\n/**\r\n * Change a users name.\r\n */\r\nexport function changeUsername(req, res) {\r\n  var userId = req.user._id;\r\n  var newUsername = String(req.body.newUsername);\r\n  return User.findById(userId).exec()\r\n    .then(user => {\r\n      user.name = newUsername;\r\n      return user.save()\r\n        .then(() => {\r\n          res.status(204).end();\r\n        })\r\n        .catch(validationError(res));\r\n    });\r\n}\r\n\r\n/**\r\n * Get my info\r\n */\r\nexport function me(req, res, next) {\r\n  var userId = req.user._id;\r\n\r\n  return User.findOne({ _id: userId }, '-salt -password').populate('characters', '').exec()\r\n    .then(user => { // don't ever give out the password or salt\r\n      if(!user) {\r\n        return res.status(401).end();\r\n      }\r\n      return res.json(user);\r\n    })\r\n    .catch(err => next(err));\r\n}\r\n\r\n/**\r\n * Authentication callback\r\n */\r\nexport function authCallback(req, res) {\r\n  res.redirect('/');\r\n}\r\n"]}